/**
 * Blue Noise texture created by Christoph Peters, released under CC0
 * http://momentsingraphics.de/BlueNoise.html
 */

#version 120
#ifdef GL_ES
    precision mediump float;
#endif


varying vec4 v_color;
varying vec2 v_texCoords;
uniform sampler2D u_texture;

vec4 bayerTex[256] = vec4[](
vec4( 65, 205, 111,  82),
vec4(  0, 255,  65, 133),
vec4(134,  25,  88,   9),
vec4(185, 105, 231,  39),
vec4( 66, 161, 152, 139),
vec4( 35,  91, 170, 203),
vec4(115, 247,  78,   3),
vec4(144,  22, 193,  59),
vec4(157, 165, 156, 148),
vec4(245, 114, 131, 233),
vec4( 57, 192, 202, 132),
vec4( 15,  30, 162,  31),
vec4( 83, 217,  17,  63),
vec4( 39, 147, 189, 214),
vec4(129,  71, 168, 106),
vec4(243, 135,   1, 195),
vec4( 75, 173, 213, 232),
vec4(233, 122, 175, 161),
vec4(203, 142,  26, 213),
vec4( 21, 234, 118, 251),
vec4( 86,   1,   7,  70),
vec4(162, 218, 222, 113),
vec4(249, 150, 105, 244),
vec4( 49, 186,  51, 124),
vec4( 11,  41, 229, 183),
vec4( 90,  65,   4,  22),
vec4(186, 252,  43, 115),
vec4(165, 131, 141, 166),
vec4(202,  53, 221, 239),
vec4(228,  20,  69,   1),
vec4(173, 226, 230, 123),
vec4( 29,  39, 130,  43),
vec4(124,  15, 251,  28),
vec4( 98, 216,  79,  90),
vec4(145,  47, 137,  53),
vec4(225, 198, 203, 197),
vec4( 54,  60, 190,  25),
vec4(130, 133,  38, 172),
vec4(218,  75, 143,  46),
vec4(105, 124, 243,  97),
vec4(201, 227, 115, 218),
vec4(123,  84,  81,  68),
vec4( 32,   4,  97, 207),
vec4(133, 179, 254,  84),
vec4( 99,  79,  55,  50),
vec4(  9, 160, 119, 184),
vec4(108, 189,  92, 141),
vec4(194,  86,  47, 246),
vec4( 48, 111, 185,  67),
vec4(170, 157,  14, 147),
vec4( 12,  70,  54, 122),
vec4(110,  98, 235, 105),
vec4(197, 180,  70, 155),
vec4(177,  31,  94,  85),
vec4(  4, 239,  21, 224),
vec4( 78,  14, 167,  30),
vec4(172, 106, 183, 162),
vec4(234, 209, 212,   6),
vec4(221, 144, 151, 254),
vec4( 73, 235, 178, 103),
vec4(250, 101,  23, 151),
vec4( 60, 119, 205, 221),
vec4(156, 248, 154,  13),
vec4(217,  59,  31, 168),
vec4(238, 238, 144, 209),
vec4( 37, 177, 223, 227),
vec4(154,  11, 165, 182),
vec4(254, 249, 108,   5),
vec4( 74, 164, 153, 238),
vec4( 30, 112, 253, 128),
vec4(239, 201, 126, 190),
vec4(139,  49,  59, 145),
vec4( 63, 172,  11,  78),
vec4( 20, 156,  32, 200),
vec4( 46,  27,  72, 135),
vec4(148,  44, 107,  38),
vec4(180, 196, 192, 193),
vec4( 24,   9,   6,  72),
vec4(140, 208, 242,  96),
vec4( 84, 138, 102, 114),
vec4(182,  34, 199,  19),
vec4( 64,  81, 122,  45),
vec4(208, 128,  91,  79),
vec4( 92, 211,  28,  36),
vec4(122,  23,  44, 212),
vec4( 44,  83, 187,  58),
vec4(190, 139, 216,  11),
vec4( 96, 223,  85, 241),
vec4(159,  92, 198, 117),
vec4(113,  58, 232,  55),
vec4(193, 129, 136, 173),
vec4( 85, 215, 238,  15),
vec4(211,  69,  62, 125),
vec4(118, 166, 129, 243),
vec4(242,  26, 172,  54),
vec4(  6,  95,  73, 179),
vec4(106, 224,  57, 129),
vec4(127, 199,   8, 252),
vec4(227, 145, 247, 164),
vec4( 18,  43, 209, 201),
vec4(168, 229, 173, 137),
vec4(150, 154,   0,  71),
vec4(216,  67, 140, 177),
vec4( 14,   3, 104, 102),
vec4(206, 194, 160,  41),
vec4(252, 245, 121, 229),
vec4(128, 181,  41,  93),
vec4(  1, 110, 164, 236),
vec4(166, 241,  25, 160),
vec4( 40, 149,  86,  29),
vec4( 70,  50, 225, 204),
vec4(198, 183,  40, 143),
vec4(163,  64, 159, 231),
vec4( 26,   2, 179, 104),
vec4( 79, 115, 133,  91),
vec4(188,  56,  63,  23),
vec4( 58,  97, 116, 112),
vec4(246, 187,  77, 247),
vec4(114, 254, 226, 158),
vec4( 82,  37,  50,  18),
vec4( 53, 120, 249, 205),
vec4( 33,  78,  19, 150),
vec4(224,  13,  95, 186),
vec4(103,  36, 219,  64),
vec4( 55,  87, 197, 110),
vec4(230, 127, 147, 216),
vec4( 95, 213, 114,  87),
vec4(137, 108, 208,   2),
vec4(251, 236, 233, 192),
vec4( 50, 169,  20,  57),
vec4(204, 193,  84, 153),
vec4(142, 242, 149, 188),
vec4(101, 125, 240, 225),
vec4(  8,  19,  36,  48),
vec4(132, 176, 194,  86),
vec4(232, 103,  15, 215),
vec4(181, 162,  67, 121),
vec4(143, 220, 206,  26),
vec4( 69, 140, 180,  80),
vec4(171, 171,  74,   7),
vec4(189, 230,  52, 140),
vec4(149,   6, 250,  42),
vec4(215,  77,  13, 175),
vec4( 16, 155,  98,  74),
vec4(176, 136,  68,  34),
vec4(116,  21, 195, 217),
vec4(241,  88,  48,  14),
vec4( 38,  33, 220,  66),
vec4(222, 210, 182, 171),
vec4(175,  76,  96,  32),
vec4( 71, 134, 155, 131),
vec4( 41,  54, 127, 185),
vec4(158, 206, 171,  61),
vec4( 91,  24, 145, 248),
vec4( 22,  99, 112, 167),
vec4(244, 202,   2, 222),
vec4( 10,  62, 125, 196),
vec4(121, 188, 184, 250),
vec4( 34, 253,  35, 120),
vec4( 88,  40, 139, 157),
vec4(152, 102, 106, 107),
vec4( 68,  72, 255, 134),
vec4(  2, 219, 123, 240),
vec4(160, 151,  30, 118),
vec4( 89, 163,  10, 146),
vec4(210,   8, 109,  99),
vec4( 27, 222, 236, 230),
vec4(196, 237, 214,   0),
vec4(120, 148,  87, 144),
vec4(219,  68,  37, 108),
vec4(199, 250, 246,  49),
vec4(111,  48, 228, 130),
vec4( 80, 132, 158,  98),
vec4(236, 116,  83,  60),
vec4( 61,  18, 215,  24),
vec4(192, 175, 169, 237),
vec4(231,  52,   5, 181),
vec4( 97, 244, 157,  47),
vec4(187, 184,  90,  81),
vec4(126, 109, 204, 208),
vec4( 51,  61, 142,  10),
vec4(109, 190,  53, 255),
vec4(147, 117,  71,  73),
vec4(240,  42,  24, 199),
vec4(  3,  89, 188,  89),
vec4( 59,  10,  58, 234),
vec4(135, 182, 101,  33),
vec4( 47, 158, 135, 211),
vec4(155,  29,  27,  12),
vec4(207,  93,  64, 149),
vec4(131, 221, 239,  88),
vec4( 42, 207,  45, 202),
vec4( 13, 123, 132,   4),
vec4(138,   7, 227, 165),
vec4(200, 141,  60,  95),
vec4(226,  45, 174, 194),
vec4( 19, 251, 244,  40),
vec4(253,  96, 163, 178),
vec4(183,  28, 201,  52),
vec4( 77, 197, 120, 163),
vec4(104, 168, 224,  20),
vec4(164, 126,  12, 180),
vec4(248, 107, 166, 154),
vec4(179, 225, 196,  76),
vec4( 28, 195, 207, 189),
vec4(100, 143,  93, 170),
vec4(167,  82, 117, 228),
vec4(220, 159, 191,  69),
vec4(112,  32,  75, 142),
vec4( 56, 200, 210, 245),
vec4( 31,  85,  34,  27),
vec4( 81,  16, 113, 152),
vec4(169, 130,  80, 219),
vec4( 62, 231,   3, 127),
vec4(136, 146, 134, 109),
vec4( 45,  80,  42, 136),
vec4(205, 243, 148, 210),
vec4( 17, 214, 237,  65),
vec4( 87,  38,  76, 119),
vec4(223,  73,  49, 242),
vec4( 67, 246,   9,  51),
vec4(  5,   0, 150, 111),
vec4(255,  63, 176,  37),
vec4( 76, 233,  22, 126),
vec4(146, 113, 100,  56),
vec4(214, 153, 146, 223),
vec4(247, 228,  16, 116),
vec4(119, 170, 186,  62),
vec4(153, 212, 217,  77),
vec4(  7,  66,  99,  16),
vec4( 94, 178, 252, 226),
vec4(229,   5, 177,  35),
vec4(174, 137,  89, 249),
vec4(125,  57, 110, 101),
vec4( 36,  17, 181,   8),
vec4(141, 174, 124, 220),
vec4(195, 121, 218, 138),
vec4(117,  46, 234,  17),
vec4(184, 167,  56, 253),
vec4( 23, 185, 248, 206),
vec4(161,  94, 200,  21),
vec4(178,  55, 161, 100),
vec4( 43,  74, 241, 187),
vec4(102, 191,  46, 169),
vec4(235,  35, 128, 235),
vec4(209, 118,  61,  94),
vec4(191,  51,  29, 159),
vec4( 25, 204, 211, 191),
vec4( 72, 100,  18,  83),
vec4(213, 232,  66,  44),
vec4(107, 152, 245, 174),
vec4(237,  90,  33, 198),
vec4(151, 203, 103,  92),
vec4( 52, 104,  82, 156),
vec4(212, 240, 138,  75),
vec4( 93,  12,  39, 176)
);

float bayerSize = 16.0;
float bayerDivider = bayerSize * bayerSize;

float quant = 63.0; // 64 steps -> 63.0; 256 steps -> 255.0
vec4 quantiser = vec4(quant);
vec4 quantiserDivider = vec4(1.0 / quant);

vec2 boolean = vec2(0.0, 1.0);
vec4 halfvec = vec4(0.5);

vec4 nearestColour(vec4 inColor) {
    return floor(quantiser * inColor + halfvec) * quantiserDivider;
}

vec4 getDitherredDot(vec4 inColor) {
    vec2 entry = mod(gl_FragCoord.xy, vec2(bayerSize, bayerSize));
    int index = int(entry.y) * int(bayerSize) + int(entry.x);
    vec4 bayerThreshold = vec4(bayerTex[index] / bayerDivider - 0.5);
    return nearestColour(inColor + bayerThreshold * quantiserDivider);
}

vec4 gammaIn(vec4 col) {
    return pow(col, vec4(2.2));
}

vec4 gammaOut(vec4 col) {
    return pow(col, vec4(1.0 / 2.2));
}

void main(void) {
    // create texture coordinates based on pixelSize //
    vec4 inColor = v_color * (texture2D(u_texture, v_texCoords)).aaaa;
    vec4 selvec = getDitherredDot(inColor);

    gl_FragColor = selvec * boolean.yyyx + boolean.xxxy; // use quantised RGB but not the A
}