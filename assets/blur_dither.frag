#ifdef GL_ES
    precision mediump float;
#endif


varying vec4 v_color;
varying vec2 v_texCoords;
uniform sampler2D u_texture;


vec4 bayerTex[256] = vec4[](
vec4( 82,  65, 205, 111),
vec4(133,   0, 255,  65),
vec4(  9, 134,  25,  88),
vec4( 39, 185, 105, 231),
vec4(139,  66, 161, 152),
vec4(203,  35,  91, 170),
vec4(  3, 115, 247,  78),
vec4( 59, 144,  22, 193),
vec4(148, 157, 165, 156),
vec4(233, 245, 114, 131),
vec4(132,  57, 192, 202),
vec4( 31,  15,  30, 162),
vec4( 63,  83, 217,  17),
vec4(214,  39, 147, 189),
vec4(106, 129,  71, 168),
vec4(195, 243, 135,   1),
vec4(232,  75, 173, 213),
vec4(161, 233, 122, 175),
vec4(213, 203, 142,  26),
vec4(251,  21, 234, 118),
vec4( 70,  86,   1,   7),
vec4(113, 162, 218, 222),
vec4(244, 249, 150, 105),
vec4(124,  49, 186,  51),
vec4(183,  11,  41, 229),
vec4( 22,  90,  65,   4),
vec4(115, 186, 252,  43),
vec4(166, 165, 131, 141),
vec4(239, 202,  53, 221),
vec4(  1, 228,  20,  69),
vec4(123, 173, 226, 230),
vec4( 43,  29,  39, 130),
vec4( 28, 124,  15, 251),
vec4( 90,  98, 216,  79),
vec4( 53, 145,  47, 137),
vec4(197, 225, 198, 203),
vec4( 25,  54,  60, 190),
vec4(172, 130, 133,  38),
vec4( 46, 218,  75, 143),
vec4( 97, 105, 124, 243),
vec4(218, 201, 227, 115),
vec4( 68, 123,  84,  81),
vec4(207,  32,   4,  97),
vec4( 84, 133, 179, 254),
vec4( 50,  99,  79,  55),
vec4(184,   9, 160, 119),
vec4(141, 108, 189,  92),
vec4(246, 194,  86,  47),
vec4( 67,  48, 111, 185),
vec4(147, 170, 157,  14),
vec4(122,  12,  70,  54),
vec4(105, 110,  98, 235),
vec4(155, 197, 180,  70),
vec4( 85, 177,  31,  94),
vec4(224,   4, 239,  21),
vec4( 30,  78,  14, 167),
vec4(162, 172, 106, 183),
vec4(  6, 234, 209, 212),
vec4(254, 221, 144, 151),
vec4(103,  73, 235, 178),
vec4(151, 250, 101,  23),
vec4(221,  60, 119, 205),
vec4( 13, 156, 248, 154),
vec4(168, 217,  59,  31),
vec4(209, 238, 238, 144),
vec4(227,  37, 177, 223),
vec4(182, 154,  11, 165),
vec4(  5, 254, 249, 108),
vec4(238,  74, 164, 153),
vec4(128,  30, 112, 253),
vec4(190, 239, 201, 126),
vec4(145, 139,  49,  59),
vec4( 78,  63, 172,  11),
vec4(200,  20, 156,  32),
vec4(135,  46,  27,  72),
vec4( 38, 148,  44, 107),
vec4(193, 180, 196, 192),
vec4( 72,  24,   9,   6),
vec4( 96, 140, 208, 242),
vec4(114,  84, 138, 102),
vec4( 19, 182,  34, 199),
vec4( 45,  64,  81, 122),
vec4( 79, 208, 128,  91),
vec4( 36,  92, 211,  28),
vec4(212, 122,  23,  44),
vec4( 58,  44,  83, 187),
vec4( 11, 190, 139, 216),
vec4(241,  96, 223,  85),
vec4(117, 159,  92, 198),
vec4( 55, 113,  58, 232),
vec4(173, 193, 129, 136),
vec4( 15,  85, 215, 238),
vec4(125, 211,  69,  62),
vec4(243, 118, 166, 129),
vec4( 54, 242,  26, 172),
vec4(179,   6,  95,  73),
vec4(129, 106, 224,  57),
vec4(252, 127, 199,   8),
vec4(164, 227, 145, 247),
vec4(201,  18,  43, 209),
vec4(137, 168, 229, 173),
vec4( 71, 150, 154,   0),
vec4(177, 216,  67, 140),
vec4(102,  14,   3, 104),
vec4( 41, 206, 194, 160),
vec4(229, 252, 245, 121),
vec4( 93, 128, 181,  41),
vec4(236,   1, 110, 164),
vec4(160, 166, 241,  25),
vec4( 29,  40, 149,  86),
vec4(204,  70,  50, 225),
vec4(143, 198, 183,  40),
vec4(231, 163,  64, 159),
vec4(104,  26,   2, 179),
vec4( 91,  79, 115, 133),
vec4( 23, 188,  56,  63),
vec4(112,  58,  97, 116),
vec4(247, 246, 187,  77),
vec4(158, 114, 254, 226),
vec4( 18,  82,  37,  50),
vec4(205,  53, 120, 249),
vec4(150,  33,  78,  19),
vec4(186, 224,  13,  95),
vec4( 64, 103,  36, 219),
vec4(110,  55,  87, 197),
vec4(216, 230, 127, 147),
vec4( 87,  95, 213, 114),
vec4(  2, 137, 108, 208),
vec4(192, 251, 236, 233),
vec4( 57,  50, 169,  20),
vec4(153, 204, 193,  84),
vec4(188, 142, 242, 149),
vec4(225, 101, 125, 240),
vec4( 48,   8,  19,  36),
vec4( 86, 132, 176, 194),
vec4(215, 232, 103,  15),
vec4(121, 181, 162,  67),
vec4( 26, 143, 220, 206),
vec4( 80,  69, 140, 180),
vec4(  7, 171, 171,  74),
vec4(140, 189, 230,  52),
vec4( 42, 149,   6, 250),
vec4(175, 215,  77,  13),
vec4( 74,  16, 155,  98),
vec4( 34, 176, 136,  68),
vec4(217, 116,  21, 195),
vec4( 14, 241,  88,  48),
vec4( 66,  38,  33, 220),
vec4(171, 222, 210, 182),
vec4( 32, 175,  76,  96),
vec4(131,  71, 134, 155),
vec4(185,  41,  54, 127),
vec4( 61, 158, 206, 171),
vec4(248,  91,  24, 145),
vec4(167,  22,  99, 112),
vec4(222, 244, 202,   2),
vec4(196,  10,  62, 125),
vec4(250, 121, 188, 184),
vec4(120,  34, 253,  35),
vec4(157,  88,  40, 139),
vec4(107, 152, 102, 106),
vec4(134,  68,  72, 255),
vec4(240,   2, 219, 123),
vec4(118, 160, 151,  30),
vec4(146,  89, 163,  10),
vec4( 99, 210,   8, 109),
vec4(230,  27, 222, 236),
vec4(  0, 196, 237, 214),
vec4(144, 120, 148,  87),
vec4(108, 219,  68,  37),
vec4( 49, 199, 250, 246),
vec4(130, 111,  48, 228),
vec4( 98,  80, 132, 158),
vec4( 60, 236, 116,  83),
vec4( 24,  61,  18, 215),
vec4(237, 192, 175, 169),
vec4(181, 231,  52,   5),
vec4( 47,  97, 244, 157),
vec4( 81, 187, 184,  90),
vec4(208, 126, 109, 204),
vec4( 10,  51,  61, 142),
vec4(255, 109, 190,  53),
vec4( 73, 147, 117,  71),
vec4(199, 240,  42,  24),
vec4( 89,   3,  89, 188),
vec4(234,  59,  10,  58),
vec4( 33, 135, 182, 101),
vec4(211,  47, 158, 135),
vec4( 12, 155,  29,  27),
vec4(149, 207,  93,  64),
vec4( 88, 131, 221, 239),
vec4(202,  42, 207,  45),
vec4(  4,  13, 123, 132),
vec4(165, 138,   7, 227),
vec4( 95, 200, 141,  60),
vec4(194, 226,  45, 174),
vec4( 40,  19, 251, 244),
vec4(178, 253,  96, 163),
vec4( 52, 183,  28, 201),
vec4(163,  77, 197, 120),
vec4( 20, 104, 168, 224),
vec4(180, 164, 126,  12),
vec4(154, 248, 107, 166),
vec4( 76, 179, 225, 196),
vec4(189,  28, 195, 207),
vec4(170, 100, 143,  93),
vec4(228, 167,  82, 117),
vec4( 69, 220, 159, 191),
vec4(142, 112,  32,  75),
vec4(245,  56, 200, 210),
vec4( 27,  31,  85,  34),
vec4(152,  81,  16, 113),
vec4(219, 169, 130,  80),
vec4(127,  62, 231,   3),
vec4(109, 136, 146, 134),
vec4(136,  45,  80,  42),
vec4(210, 205, 243, 148),
vec4( 65,  17, 214, 237),
vec4(119,  87,  38,  76),
vec4(242, 223,  73,  49),
vec4( 51,  67, 246,   9),
vec4(111,   5,   0, 150),
vec4( 37, 255,  63, 176),
vec4(126,  76, 233,  22),
vec4( 56, 146, 113, 100),
vec4(223, 214, 153, 146),
vec4(116, 247, 228,  16),
vec4( 62, 119, 170, 186),
vec4( 77, 153, 212, 217),
vec4( 16,   7,  66,  99),
vec4(226,  94, 178, 252),
vec4( 35, 229,   5, 177),
vec4(249, 174, 137,  89),
vec4(101, 125,  57, 110),
vec4(  8,  36,  17, 181),
vec4(220, 141, 174, 124),
vec4(138, 195, 121, 218),
vec4( 17, 117,  46, 234),
vec4(253, 184, 167,  56),
vec4(206,  23, 185, 248),
vec4( 21, 161,  94, 200),
vec4(100, 178,  55, 161),
vec4(187,  43,  74, 241),
vec4(169, 102, 191,  46),
vec4(235, 235,  35, 128),
vec4( 94, 209, 118,  61),
vec4(159, 191,  51,  29),
vec4(191,  25, 204, 211),
vec4( 83,  72, 100,  18),
vec4( 44, 213, 232,  66),
vec4(174, 107, 152, 245),
vec4(198, 237,  90,  33),
vec4( 92, 151, 203, 103),
vec4(156,  52, 104,  82),
vec4( 75, 212, 240, 138),
vec4(176,  93,  12,  39)
);

float bayerSize = 16.0;
float bayerDivider = bayerSize * bayerSize;

float quant = 63.0; // 64 steps -> 63.0; 256 steps -> 255.0
vec4 quantiser = vec4(quant);
vec4 quantiserDivider = vec4(1.0 / quant);

vec2 boolean = vec2(0.0, 1.0);
vec4 halfvec = vec4(0.5);

vec4 nearestColour(vec4 inColor) {
    return floor(quantiser * inColor + halfvec) * quantiserDivider;
}

vec4 getDitherredDot(vec4 inColor) {
    vec2 entry = mod(gl_FragCoord.xy, vec2(bayerSize, bayerSize));
    int index = int(entry.y) * int(bayerSize) + int(entry.x);
    vec4 bayerThreshold = vec4(bayerTex[index] / bayerDivider - 0.5);
    return nearestColour(inColor + bayerThreshold * quantiserDivider);
}

uniform vec2 iResolution;
uniform float flip;
uniform vec2 direction;

vec4 blur(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {
    vec4 color = vec4(0.0);
    vec2 off1 = vec2(1.3846153846) * direction;
    vec2 off2 = vec2(3.2307692308) * direction;
    color += texture2D(image, uv) * 0.2270270270;
    color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;
    color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;
    color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;
    color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;
    return color;
}

void main() {
    vec2 uv = vec2(gl_FragCoord.xy / iResolution.xy);
    if (flip == 1.0) { uv.y = 1.0 - uv.y; }

    vec4 inColor = blur(u_texture, uv, iResolution.xy, direction);
    vec4 selvec = getDitherredDot(inColor);

    gl_FragColor = selvec * boolean.yyyx + inColor * boolean.xxxy; // use quantised RGB but not the A
}